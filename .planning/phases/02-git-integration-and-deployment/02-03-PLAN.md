---
phase: 02-git-integration-and-deployment
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/Jobs/SyncContentFromGitJob.php
  - app/Notifications/ContentSyncFailedNotification.php
  - app/Notifications/WebhookAuthFailedNotification.php
  - app/Http/Controllers/WebhookController.php
autonomous: true

must_haves:
  truths:
    - "Webhook receipt dispatches a queued background job"
    - "Sync job pulls git repo then runs ContentIndexer on changed files"
    - "Failed jobs retry 3 times with exponential backoff then send email notification"
    - "Webhook auth failures send email notification to admin"
    - "Job has configurable retry count and backoff via environment variables"
  artifacts:
    - path: "app/Jobs/SyncContentFromGitJob.php"
      provides: "Queued content sync job with retry logic"
      exports: ["handle", "failed", "middleware"]
    - path: "app/Notifications/ContentSyncFailedNotification.php"
      provides: "Email notification for failed sync jobs"
      exports: ["toMail"]
    - path: "app/Notifications/WebhookAuthFailedNotification.php"
      provides: "Email notification for webhook auth failures"
      exports: ["toMail"]
  key_links:
    - from: "app/Http/Controllers/WebhookController.php"
      to: "app/Jobs/SyncContentFromGitJob.php"
      via: "SyncContentFromGitJob::dispatch()"
      pattern: "SyncContentFromGitJob::dispatch"
    - from: "app/Jobs/SyncContentFromGitJob.php"
      to: "app/Services/Content/GitSyncService.php"
      via: "constructor injection in handle()"
      pattern: "GitSyncService.*pullLatest"
    - from: "app/Jobs/SyncContentFromGitJob.php"
      to: "app/Services/Content/ContentIndexer.php"
      via: "constructor injection in handle()"
      pattern: "ContentIndexer.*(detectChanges|indexFile|indexAll)"
    - from: "app/Jobs/SyncContentFromGitJob.php"
      to: "app/Notifications/ContentSyncFailedNotification.php"
      via: "failed() method"
      pattern: "ContentSyncFailedNotification"
    - from: "app/Http/Controllers/WebhookController.php"
      to: "app/Notifications/WebhookAuthFailedNotification.php"
      via: "Notification::route() on auth failure"
      pattern: "WebhookAuthFailedNotification"
---

<objective>
Create the queued sync job that connects GitSyncService and ContentIndexer, wire it into the WebhookController, and add email notifications for failures. This plan completes the automated content publishing pipeline: webhook -> job dispatch -> git pull -> content indexing.

Purpose: This is the critical wiring plan that connects the webhook endpoint (Plan 02) to the git sync service (Plan 01) and existing ContentIndexer (Phase 1). Without this, webhooks are received but no content is synced.

Output: A fully wired automated pipeline where GitHub push events trigger background content sync with retry logic and failure notifications.
</objective>

<execution_context>
@/home/human/.claude/get-shit-done/workflows/execute-plan.md
@/home/human/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-git-integration-and-deployment/02-RESEARCH.md
@.planning/phases/02-git-integration-and-deployment/02-01-SUMMARY.md
@.planning/phases/02-git-integration-and-deployment/02-02-SUMMARY.md
@app/Services/Content/ContentIndexer.php
@app/Services/Content/GitSyncService.php
@app/Http/Controllers/WebhookController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncContentFromGitJob with retry logic</name>
  <files>
    app/Jobs/SyncContentFromGitJob.php
  </files>
  <action>
Create `app/Jobs/SyncContentFromGitJob.php` implementing `ShouldQueue` and `ShouldBeUnique`:

1. **Class setup:**
   - Implements: `ShouldQueue`, `ShouldBeUnique`
   - Uses: `Queueable` trait (from `Illuminate\Bus\Queueable`, `Illuminate\Contracts\Queue\ShouldQueue`, `Illuminate\Foundation\Bus\Dispatchable`, `Illuminate\Queue\InteractsWithQueue`, `Illuminate\Queue\SerializesModels`)
   - Properties:
     - `public string $deliveryId` (constructor param) -- GitHub delivery ID for unique job tracking
     - `public int $uniqueFor = 3600` -- prevent duplicate jobs for 1 hour
     - `public int $timeout = 300` -- 5 minute timeout per attempt

2. **Constructor:** Accept `string $deliveryId`. Store it.

3. **uniqueId(): string** -- Return `$this->deliveryId` so ShouldBeUnique uses GitHub delivery ID.

4. **middleware(): array** -- Return ThrottlesExceptions middleware:
   ```php
   return [
       (new ThrottlesExceptions(
           config('git-sync.job_max_exceptions', 3),
           config('git-sync.job_backoff_minutes', 5) * 60
       ))->backoff(config('git-sync.job_backoff_minutes', 5))
   ];
   ```
   Use `Illuminate\Queue\Middleware\ThrottlesExceptions`.

5. **retryUntil(): \DateTime** -- Return `now()->addMinutes(30)` -- time-based retry window.

6. **handle(GitSyncService $gitSync, ContentIndexer $indexer): void** -- Main job logic:
   - Log::info('Content sync started', ['delivery_id' => $this->deliveryId])
   - Call `$gitSync->pullLatest()` to clone/pull the repository
   - Get content path: `$gitSync->getContentPath()`
   - Update the ContentIndexer's content path if needed, OR call `$indexer->detectChanges()` to find changed files
   - For each changed file, call `$indexer->indexFile($filepath)`
   - If no changed files found, call `$indexer->indexAll()` as fallback (handles first sync after clone)
   - Log::info('Content sync completed', ['delivery_id' => $this->deliveryId, 'files_processed' => $count])

   IMPORTANT: The existing ContentIndexer reads from `base_path('content/posts/')`. After git clone, content lives at `storage_path('app/content-repo/content/posts/')`. The job must handle this path difference. Options:
   - Symlink content-repo/content/posts to base_path('content/posts') after clone (simplest)
   - OR pass the git repo content path directly to indexer methods

   Preferred approach: After pullLatest(), create/update a symlink from `base_path('content/posts')` to `$gitSync->getContentPath()`. This way the existing ContentIndexer works unchanged. Use PHP's `symlink()` function. Remove existing symlink first if present (`is_link()` check then `unlink()`). Ensure the parent directory exists (`base_path('content')`).

7. **failed(Throwable $exception): void** -- Failure handler:
   - Log::error('Content sync job failed permanently', ['delivery_id' => $this->deliveryId, 'error' => $exception->getMessage()])
   - Send notification: `Notification::route('mail', config('git-sync.admin_email', config('mail.from.address')))->notify(new ContentSyncFailedNotification($exception, $this->deliveryId))`

Also add these config keys to `config/git-sync.php` (read existing file first, then add):
- `'job_max_exceptions' => (int) env('GIT_SYNC_JOB_MAX_EXCEPTIONS', 3)`
- `'job_backoff_minutes' => (int) env('GIT_SYNC_JOB_BACKOFF', 5)`
- `'admin_email' => env('ADMIN_EMAIL')`
  </action>
  <verify>
1. `php artisan tinker --execute="new App\Jobs\SyncContentFromGitJob('test-delivery-id')"` -- instantiates without error
2. Verify class implements ShouldQueue: `grep -c 'ShouldQueue' app/Jobs/SyncContentFromGitJob.php` should be >= 1
3. Verify ThrottlesExceptions middleware: `grep -c 'ThrottlesExceptions' app/Jobs/SyncContentFromGitJob.php` should be >= 1
4. Verify config loads: `php artisan tinker --execute="config('git-sync.job_max_exceptions')"` should return 3
  </verify>
  <done>SyncContentFromGitJob implements ShouldQueue + ShouldBeUnique with GitHub delivery ID. Uses ThrottlesExceptions for exponential backoff with configurable retry count/timing. handle() calls GitSyncService::pullLatest() then creates symlink and runs ContentIndexer. failed() sends ContentSyncFailedNotification email.</done>
</task>

<task type="auto">
  <name>Task 2: Create notifications and wire job dispatch into WebhookController</name>
  <files>
    app/Notifications/ContentSyncFailedNotification.php
    app/Notifications/WebhookAuthFailedNotification.php
    app/Http/Controllers/WebhookController.php
  </files>
  <action>
**ContentSyncFailedNotification** (`app/Notifications/ContentSyncFailedNotification.php`):

Create notification class extending `Illuminate\Notifications\Notification`:
- Constructor: Accept `Throwable $exception` and `string $deliveryId`
- `via()`: Return `['mail']`
- `toMail()`: Return MailMessage with:
  - `->error()` (red header)
  - Subject: 'Content Sync Failed'
  - Line: 'The content sync job failed after multiple retries.'
  - Line: 'Delivery ID: ' . $this->deliveryId
  - Line: 'Error: ' . $this->exception->getMessage()
  - Line: 'Please check logs and manually trigger sync if needed.'
  - Line: 'Run: php artisan content:sync --force'

**WebhookAuthFailedNotification** (`app/Notifications/WebhookAuthFailedNotification.php`):

Create notification class extending `Illuminate\Notifications\Notification`:
- Constructor: Accept `string $ipAddress`
- `via()`: Return `['mail']`
- `toMail()`: Return MailMessage with:
  - `->error()` (red header)
  - Subject: 'Webhook Authentication Failed'
  - Line: 'A webhook request with invalid signature was received.'
  - Line: 'Source IP: ' . $this->ipAddress
  - Line: 'This could indicate a misconfigured webhook or an unauthorized access attempt.'

**Update WebhookController** (read existing file first):

1. Add `use App\Jobs\SyncContentFromGitJob;` and `use App\Notifications\WebhookAuthFailedNotification;` and `use Illuminate\Support\Facades\Notification;` imports.

2. In the handle() method, replace the TODO comment for job dispatch with:
   ```php
   SyncContentFromGitJob::dispatch($deliveryId);
   ```

3. In the signature verification failure block, after the Log::warning, add:
   ```php
   Notification::route('mail', config('git-sync.admin_email', config('mail.from.address')))
       ->notify(new WebhookAuthFailedNotification($request->ip()));
   ```

4. Keep all existing validation logic (idempotency, branch filtering, event type filtering) unchanged.
  </action>
  <verify>
1. `php artisan tinker --execute="new App\Notifications\ContentSyncFailedNotification(new RuntimeException('test'), 'abc-123')"` -- instantiates
2. `php artisan tinker --execute="new App\Notifications\WebhookAuthFailedNotification('127.0.0.1')"` -- instantiates
3. Verify job dispatch wiring: `grep 'SyncContentFromGitJob::dispatch' app/Http/Controllers/WebhookController.php` returns a match
4. Verify notification wiring: `grep 'WebhookAuthFailedNotification' app/Http/Controllers/WebhookController.php` returns a match
5. Run `php artisan route:list --path=api` to confirm routes still work after controller changes
  </verify>
  <done>ContentSyncFailedNotification and WebhookAuthFailedNotification send error emails. WebhookController dispatches SyncContentFromGitJob on valid webhook. Auth failures trigger WebhookAuthFailedNotification. Full pipeline wired: webhook -> validate -> dispatch job -> git pull -> index content.</done>
</task>

</tasks>

<verification>
- WebhookController dispatches SyncContentFromGitJob (grep confirms)
- SyncContentFromGitJob calls GitSyncService::pullLatest() and ContentIndexer (grep confirms)
- Failed jobs trigger ContentSyncFailedNotification email
- Webhook auth failures trigger WebhookAuthFailedNotification email
- ThrottlesExceptions middleware configured with environment-backed values
- ShouldBeUnique uses GitHub delivery ID for deduplication
- All classes autoload and instantiate without errors
</verification>

<success_criteria>
- Complete automated pipeline: GitHub push -> webhook -> validated -> job dispatched -> git pulled -> content indexed
- Failed sync jobs retry 3 times with 5-minute exponential backoff
- After final failure, admin receives email notification with error details
- Webhook auth failures send immediate email alert to admin
- Job retry count and backoff timing configurable via environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/02-git-integration-and-deployment/02-03-SUMMARY.md`
</output>
