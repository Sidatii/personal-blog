---
phase: 02-git-integration-and-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/git-sync.php
  - app/Services/Content/GitSyncService.php
  - .env.example
  - .env
autonomous: true

must_haves:
  truths:
    - "Git repository can be cloned to local storage on first run"
    - "Subsequent runs pull latest changes instead of re-cloning"
    - "File locking prevents concurrent git operations"
    - "Git sync configuration is externalized via environment variables"
  artifacts:
    - path: "config/git-sync.php"
      provides: "Centralized git sync configuration"
      contains: "repository_url"
    - path: "app/Services/Content/GitSyncService.php"
      provides: "Git clone/pull with file locking"
      exports: ["pullLatest", "cloneRepository"]
  key_links:
    - from: "app/Services/Content/GitSyncService.php"
      to: "config/git-sync.php"
      via: "config() helper"
      pattern: "config\\('git-sync\\."
    - from: "app/Services/Content/GitSyncService.php"
      to: "storage/app/git-sync.lock"
      via: "flock() advisory locking"
      pattern: "flock\\(.*LOCK_EX"
---

<objective>
Create the GitSyncService and its configuration file. This service handles cloning a git repository on first run and pulling updates on subsequent runs, using flock() file locking to prevent concurrent git operations.

Purpose: Foundation service that the queued sync job (Plan 03) will call to fetch content from the remote git repository. Without this, there is no mechanism to get markdown files from GitHub onto the server.

Output: A working GitSyncService class that can clone/pull a configured git repository with exclusive file locking, plus a config/git-sync.php configuration file externalizing all settings via environment variables.
</objective>

<execution_context>
@/home/human/.claude/get-shit-done/workflows/execute-plan.md
@/home/human/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-git-integration-and-deployment/02-RESEARCH.md
@app/Services/Content/ContentIndexer.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git-sync configuration file</name>
  <files>config/git-sync.php</files>
  <action>
Create `config/git-sync.php` with the following settings, all sourced from environment variables with sensible defaults:

- `repository_url`: env('GIT_SYNC_REPOSITORY_URL') -- no default, required for production
- `branch`: env('GIT_SYNC_BRANCH', 'main') -- configurable to support staging environments
- `content_path`: env('GIT_SYNC_CONTENT_PATH', 'content/posts') -- subdirectory within repo containing markdown files
- `repo_storage_path`: storage_path('app/content-repo') -- local path where the git clone lives
- `lock_file`: storage_path('app/git-sync.lock') -- lock file path for flock()
- `webhook_secret`: env('GITHUB_WEBHOOK_SECRET') -- shared secret for HMAC verification (used by Plan 02)
- `sync_branch`: env('GIT_SYNC_BRANCH', 'main') -- alias for branch filtering in webhook controller

Also add the following entries to `.env.example` (append to end of file):

```
# Git Sync Configuration
GIT_SYNC_REPOSITORY_URL=
GIT_SYNC_BRANCH=main
GIT_SYNC_CONTENT_PATH=content/posts
GITHUB_WEBHOOK_SECRET=
ADMIN_EMAIL=
```

And add matching entries to `.env` with empty values (same block).
  </action>
  <verify>Run `php artisan config:show git-sync` to confirm configuration loads without errors. Verify all keys are present and defaults resolve correctly.</verify>
  <done>config/git-sync.php exists, loads via Laravel config system, all environment variables documented in .env.example</done>
</task>

<task type="auto">
  <name>Task 2: Create GitSyncService with file locking</name>
  <files>app/Services/Content/GitSyncService.php</files>
  <action>
Create `app/Services/Content/GitSyncService.php` in the existing Services/Content namespace. The service must:

1. **Constructor:** Accept no injected dependencies. Read all configuration from `config('git-sync.*')` in methods.

2. **pullLatest(): void** -- Main public method:
   - Open lock file at `config('git-sync.lock_file')` using fopen() with mode 'c' (create if not exists, don't truncate)
   - Attempt non-blocking exclusive lock: `flock($handle, LOCK_EX | LOCK_NB, $wouldBlock)`
   - If lock fails and $wouldBlock is true, throw RuntimeException('Another sync operation is in progress')
   - If lock fails otherwise, throw RuntimeException('Failed to acquire git sync lock')
   - Store $handle as class property ($this->lockHandle) to prevent GC from releasing lock (see Pitfall 1 in RESEARCH.md)
   - Check if repo_storage_path contains a .git directory
   - If no .git: call cloneRepository()
   - If .git exists: call pullRepository()
   - In finally block: flock($handle, LOCK_UN), fclose($handle)

3. **cloneRepository(): void** (private):
   - Get repository_url and branch from config
   - Build command: `git clone --branch {branch} --single-branch {url} {path}`
   - Use escapeshellarg() on all interpolated values
   - Execute via Process (Symfony Process component, available in Laravel)
   - If exit code is non-zero, throw RuntimeException with output
   - Log::info('Repository cloned', ['path' => ..., 'branch' => ...])

4. **pullRepository(): void** (private):
   - cd into repo_storage_path
   - Run `git fetch origin` then `git reset --hard origin/{branch}` (not just git pull -- ensures clean state even if local changes exist)
   - Use escapeshellarg() for branch interpolation
   - Execute via Process component
   - Log::info('Repository updated', ['output' => ...])

5. **getContentPath(): string** (public):
   - Returns the full path to content files: repo_storage_path + '/' + content_path config
   - Used by the sync job to know where to find markdown files

Use `Illuminate\Support\Facades\Log` for logging. Use `Symfony\Component\Process\Process` for shell commands (NOT shell_exec -- Process provides better error handling, timeout support, and output capture).

IMPORTANT: Do NOT use shell_exec() for git commands. The Symfony Process component is already available in Laravel and provides timeout support, proper exit code handling, and output capture without shell injection risks.
  </action>
  <verify>
1. Create a simple test: `php artisan tinker --execute="app(App\Services\Content\GitSyncService::class)->getContentPath()"` should return a valid path string.
2. Verify class autoloads: `php artisan tinker --execute="new App\Services\Content\GitSyncService()"` should not throw.
3. Run `php artisan config:clear && php artisan config:cache` to verify config compiles.
  </verify>
  <done>GitSyncService class exists with pullLatest(), cloneRepository(), pullRepository(), getContentPath() methods. Uses flock() with LOCK_EX|LOCK_NB for non-blocking exclusive locking. Uses Symfony Process for git commands. Stores lock handle as class property to prevent GC release.</done>
</task>

</tasks>

<verification>
- `config/git-sync.php` loads via `php artisan config:show git-sync`
- `GitSyncService` instantiates without error
- `getContentPath()` returns expected path
- `.env.example` contains all required git sync environment variables
- No use of shell_exec() in GitSyncService
</verification>

<success_criteria>
- GitSyncService can be instantiated and its public methods are callable
- Configuration is fully externalized (no hardcoded URLs, branches, or paths)
- File locking uses class property pattern to prevent premature lock release
- Git commands use Symfony Process component (not shell_exec)
</success_criteria>

<output>
After completion, create `.planning/phases/02-git-integration-and-deployment/02-01-SUMMARY.md`
</output>
