---
phase: 02-git-integration-and-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Services/Webhooks/GitHubWebhookValidator.php
  - app/Http/Controllers/WebhookController.php
  - routes/api.php
  - bootstrap/app.php
autonomous: true

user_setup:
  - service: github
    why: "Webhook delivery for automated content sync"
    env_vars:
      - name: GITHUB_WEBHOOK_SECRET
        source: "Generate a random string (e.g., openssl rand -hex 32), then configure in GitHub repo Settings -> Webhooks -> Add webhook -> Secret field"
    dashboard_config:
      - task: "Create webhook pointing to your-domain.com/api/webhooks/github"
        location: "GitHub Repository -> Settings -> Webhooks -> Add webhook"

must_haves:
  truths:
    - "Valid GitHub webhook signatures are accepted with 200 response"
    - "Invalid or missing signatures are rejected with 403 response"
    - "Duplicate webhook deliveries (same X-GitHub-Delivery) return 200 without reprocessing"
    - "Pushes to non-configured branches are ignored with 200 response"
    - "Webhook returns immediately (does not block on sync processing)"
  artifacts:
    - path: "app/Services/Webhooks/GitHubWebhookValidator.php"
      provides: "HMAC-SHA256 webhook signature verification"
      exports: ["verify"]
    - path: "app/Http/Controllers/WebhookController.php"
      provides: "Webhook endpoint handling with idempotency"
      exports: ["handle"]
    - path: "routes/api.php"
      provides: "POST /api/webhooks/github route"
      contains: "webhooks/github"
  key_links:
    - from: "app/Http/Controllers/WebhookController.php"
      to: "app/Services/Webhooks/GitHubWebhookValidator.php"
      via: "constructor injection"
      pattern: "GitHubWebhookValidator"
    - from: "app/Http/Controllers/WebhookController.php"
      to: "Illuminate\\Support\\Facades\\Cache"
      via: "delivery ID idempotency check"
      pattern: "Cache::(has|put).*webhook"
    - from: "routes/api.php"
      to: "app/Http/Controllers/WebhookController.php"
      via: "Route::post"
      pattern: "Route::post.*webhooks/github"
---

<objective>
Create the GitHub webhook endpoint with HMAC-SHA256 signature verification, duplicate delivery detection, and branch filtering. The controller validates incoming webhooks and will dispatch a queued sync job (wired in Plan 03).

Purpose: This is the entry point for automated content publishing. When a push happens on GitHub, this endpoint receives the event, validates authenticity, checks for duplicates, filters by branch, and queues the sync work.

Output: A secure webhook endpoint at POST /api/webhooks/github that validates signatures, deduplicates deliveries, filters branches, and is ready for job dispatch wiring in Plan 03.
</objective>

<execution_context>
@/home/human/.claude/get-shit-done/workflows/execute-plan.md
@/home/human/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-git-integration-and-deployment/02-RESEARCH.md
@.planning/phases/02-git-integration-and-deployment/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHubWebhookValidator and WebhookController</name>
  <files>
    app/Services/Webhooks/GitHubWebhookValidator.php
    app/Http/Controllers/WebhookController.php
  </files>
  <action>
**GitHubWebhookValidator** (`app/Services/Webhooks/GitHubWebhookValidator.php`):

Create a service class in a new `App\Services\Webhooks` namespace:

1. **verify(Request $request): bool** -- Public method:
   - Get `X-Hub-Signature-256` header from request
   - If header is missing or empty, return false
   - Get raw payload via `$request->getContent()`
   - Get secret from `config('git-sync.webhook_secret')`
   - If secret is empty/null, Log::error('GitHub webhook secret not configured') and return false
   - Compute expected signature: `'sha256=' . hash_hmac('sha256', $payload, $secret)`
   - Return `hash_equals($expectedSignature, $signatureHeader)` -- MUST use hash_equals() for timing-safe comparison (not === or strcmp)

**WebhookController** (`app/Http/Controllers/WebhookController.php`):

1. **Constructor injection:** Accept GitHubWebhookValidator as dependency.

2. **handle(Request $request): JsonResponse** -- Main endpoint:

   Step 1 - Validate signature:
   - Call `$this->validator->verify($request)`
   - If false: Log::warning('Webhook signature verification failed', ['ip' => $request->ip()])
   - Return `response()->json(['error' => 'Invalid signature'], 403)`

   Step 2 - Check idempotency:
   - Get delivery ID: `$request->header('X-GitHub-Delivery')`
   - If delivery ID is null, return 400 with error 'Missing delivery ID'
   - Check `Cache::has("webhook:processed:{$deliveryId}")`
   - If already processed: Log::info('Duplicate webhook skipped', ['delivery_id' => $deliveryId])
   - Return `response()->json(['status' => 'already_processed'], 200)`

   Step 3 - Filter by branch:
   - Extract branch from payload: `basename($request->input('ref', ''))` (e.g., 'refs/heads/main' -> 'main')
   - Compare against `config('git-sync.branch', 'main')`
   - If branch doesn't match: Log::info('Webhook for non-sync branch ignored', ['branch' => $branch])
   - Return `response()->json(['status' => 'ignored', 'reason' => 'branch_mismatch'], 200)`

   Step 4 - Filter by event type:
   - Check `$request->header('X-GitHub-Event')` equals 'push'
   - If not push event, return 200 with status 'ignored', reason 'not_push_event'

   Step 5 - Mark as processed and prepare for dispatch:
   - `Cache::put("webhook:processed:{$deliveryId}", true, now()->addDay())`
   - Add a TODO comment: `// TODO: Dispatch SyncContentFromGitJob here (Plan 03)`
   - Return `response()->json(['status' => 'queued'], 200)`

IMPORTANT: The controller does NOT dispatch the job yet. Plan 03 wires the actual job dispatch. This plan creates a fully testable controller that handles all validation/filtering logic.

Use these imports: `Illuminate\Http\Request`, `Illuminate\Http\JsonResponse`, `Illuminate\Support\Facades\Cache`, `Illuminate\Support\Facades\Log`.
  </action>
  <verify>
1. `php artisan tinker --execute="app(App\Services\Webhooks\GitHubWebhookValidator::class)"` -- instantiates without error
2. `php artisan tinker --execute="app(App\Http\Controllers\WebhookController::class)"` -- instantiates without error
  </verify>
  <done>GitHubWebhookValidator uses hash_equals() for timing-safe HMAC comparison. WebhookController handles signature verification, idempotency via Cache, branch filtering, and event type filtering. Job dispatch placeholder ready for Plan 03 wiring.</done>
</task>

<task type="auto">
  <name>Task 2: Register API routes and enable API routing</name>
  <files>
    routes/api.php
    bootstrap/app.php
  </files>
  <action>
**Create routes/api.php:**

Create a new `routes/api.php` file with:

```php
<?php

use App\Http\Controllers\WebhookController;
use Illuminate\Support\Facades\Route;

Route::post('/webhooks/github', [WebhookController::class, 'handle'])
    ->name('webhooks.github');
```

Note: Do NOT add auth or throttle middleware to this route. Webhook authentication is handled via HMAC signature verification in the controller, and GitHub may send rapid webhook deliveries.

**Update bootstrap/app.php:**

In Laravel 12, API routes are registered in `bootstrap/app.php`. Read the existing file and add API route registration. Look for the `withRouting` method call and add `api: __DIR__.'/../routes/api.php'` to it. If withRouting doesn't exist, add the standard Laravel 12 pattern:

```php
->withRouting(
    web: __DIR__.'/../routes/web.php',
    api: __DIR__.'/../routes/api.php',
    commands: __DIR__.'/../routes/console.php',
    health: '/up',
)
```

This registers all routes under `/api/` prefix automatically (Laravel convention). The webhook endpoint will be accessible at `POST /api/webhooks/github`.
  </action>
  <verify>
1. Run `php artisan route:list --path=api` to confirm the webhook route is registered at POST /api/webhooks/github
2. Run `php artisan route:list --name=webhooks` to verify route name resolves
3. Test with curl (should return 403 since no valid signature): `curl -s -X POST http://localhost:8000/api/webhooks/github -H "Content-Type: application/json" -d '{}' | head -20` (start server first if needed or just verify route:list output)
  </verify>
  <done>routes/api.php exists with POST /webhooks/github route. bootstrap/app.php registers API routes. Route is accessible at POST /api/webhooks/github without auth middleware. php artisan route:list shows the webhook endpoint.</done>
</task>

</tasks>

<verification>
- `php artisan route:list --path=api` shows POST /api/webhooks/github
- WebhookController instantiates with GitHubWebhookValidator injected
- No auth middleware on webhook route (signature verification is custom)
- GitHubWebhookValidator uses hash_equals() (grep confirms)
- WebhookController uses Cache for idempotency (grep confirms)
</verification>

<success_criteria>
- POST /api/webhooks/github route is registered and accessible
- Invalid signatures return 403 Forbidden
- Missing delivery ID returns 400
- Duplicate deliveries return 200 with 'already_processed'
- Non-matching branches return 200 with 'ignored'
- Non-push events return 200 with 'ignored'
- Valid push events for configured branch return 200 with 'queued'
</success_criteria>

<output>
After completion, create `.planning/phases/02-git-integration-and-deployment/02-02-SUMMARY.md`
</output>
