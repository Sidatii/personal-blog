---
phase: 05-admin-panel-and-auth
plan: 05
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - app/Models/ActivityLog.php
  - database/migrations/2026_02_08_000001_create_activity_logs_table.php
  - app/Http/Middleware/LogAdminActivity.php
  - app/Services/ActivityLogger.php
  - resources/views/admin/activity/index.blade.php
  - app/Http/Controllers/Admin/ActivityController.php
  - routes/admin.php
autonomous: false

must_haves:
  truths:
    - "Admin actions are logged with timestamp and details"
    - "Activity log viewable at /admin/activity"
    - "Logs include action type, model affected, and admin user"
    - "Logs persist for audit trail"
  artifacts:
    - path: "app/Models/ActivityLog.php"
      provides: "Activity log model"
      exports: ["ActivityLog"]
    - path: "app/Services/ActivityLogger.php"
      provides: "Logging service"
      exports: ["log", "getRecent"]
    - path: "resources/views/admin/activity/index.blade.php"
      provides: "Activity log viewer"
      contains: "activity list, filter, pagination"
  key_links:
    - from: "app/Http/Middleware/LogAdminActivity.php"
      to: "app/Services/ActivityLogger.php"
      via: "ActivityLogger::log"
      pattern: "ActivityLogger"
---

<objective>
Implement activity logging for admin actions and create activity log viewer.

Purpose: Provide audit trail of all admin actions for security and accountability.

Output: Activity logging service, middleware, model, migration, and viewer.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-admin-panel-and-auth/05-04-SUMMARY.md

@routes/admin.php
@app/Http/Controllers/Admin
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity logging infrastructure</name>
  <files>
    app/Models/ActivityLog.php
    database/migrations/2026_02_08_000001_create_activity_logs_table.php
    app/Services/ActivityLogger.php
  </files>
  <action>
    Create migration with columns:
    - id (bigIncrements)
    - admin_id (foreign key to admins)
    - action (string: created, updated, deleted, login, logout)
    - model_type (string: Post, Category, Tag, Project, ContactSubmission)
    - model_id (nullable bigint)
    - description (text, nullable - human readable summary)
    - ip_address (string, nullable)
    - user_agent (text, nullable)
    - timestamps()

    Create ActivityLog model:
    - $fillable with all columns except id/timestamps
    - belongsTo Admin
    - scopeRecent($query, $limit = 50)
    - scopeForModel($query, $modelType)
    - scopeForAction($query, $action)

    Create ActivityLogger service:
    - log($action, $model, $description = null): Create log entry with current admin, IP, user agent
    - getRecent($limit = 50): Get recent activity
    - getForModel($modelType, $modelId = null): Get activity for specific model
  </action>
  <verify>
    Migration runs: `php artisan migrate`
    Model loads: `php -l app/Models/ActivityLog.php`
    Service works: Can call ActivityLogger::log() in tinker
  </verify>
  <done>
    Activity log infrastructure ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logging to controllers and middleware</name>
  <files>
    app/Http/Middleware/LogAdminActivity.php
    app/Http/Controllers/Admin/PostController.php (modify)
    app/Http/Controllers/Admin/CategoryController.php (modify)
    app/Http/Controllers/Admin/TagController.php (modify)
    app/Http/Controllers/Admin/ProjectController.php (modify)
    app/Http/Controllers/Admin/Auth/LoginController.php (modify)
    app/Http/Controllers/Admin/Auth/LogoutController.php (modify)
  </files>
  <action>
    Create LogAdminActivity middleware:
    - Log all admin route access (optional - can be too verbose)
    - Better approach: Log specific actions in controllers

    Add logging to controllers:
    - PostController: Log create, update, delete actions
    - CategoryController: Log create, update, delete
    - TagController: Log create, update, delete
    - ProjectController: Log create, update, delete
    - LoginController: Log successful login
    - LogoutController: Log logout

    Use ActivityLogger::log() in each action:
    - After successful create: ActivityLogger::log('created', $post, "Created post: {$post->title}")
    - After update: ActivityLogger::log('updated', $post, "Updated post: {$post->title}")
    - After delete: ActivityLogger::log('deleted', null, "Deleted post ID: {$id}") (model already gone)
  </action>
  <verify>
    Actions create log entries
    Can query logs: ActivityLog::recent()->get()
  </verify>
  <done>
    All admin actions logged automatically
  </done>
</task>

<task type="auto">
  <name>Task 3: Create activity log viewer</name>
  <files>
    app/Http/Controllers/Admin/ActivityController.php
    resources/views/admin/activity/index.blade.php
  </files>
  <action>
    Create ActivityController:
    - index(Request $request): Show activity with filters
    - Support filters: action type, admin, date range, model type
    - Default: Last 50 activities, newest first

    Create view:
    - Table with: Date, Admin, Action, Model, Description
    - Color-coded action badges (green=create, blue=update, red=delete)
    - Filter dropdowns
    - Pagination (25 per page)
    - Link to view specific model if it still exists
  </action>
  <verify>
    Route: `php artisan route:list --path=admin/activity`
    Shows logged activities
  </verify>
  <done>
    Activity log viewer functional
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete admin panel with authentication, dashboard, content management (posts, categories, tags), portfolio management (projects, contacts), and activity logging.
  </what-built>
  <how-to-verify>
    1. Visit /admin/login - Login with admin@example.com / password
    2. Dashboard - Verify stats cards show correct counts
    3. Posts - Create a test post, verify it appears in frontend
    4. Categories - Create a category, assign it to a post
    5. Tags - Create tags, assign to posts
    6. Projects - Create a project, check it appears on portfolio
    7. Contacts - Submit contact form on frontend, verify it appears in admin
    8. Activity Log - Verify recent actions are logged
    9. Logout - Verify redirect to login
    10. Security - Try accessing /admin while logged out, should redirect to login
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Activity logs created for all admin actions
- /admin/activity shows audit trail
- Logs include IP and user agent
- Filterable by action type and model
- Dashboard shows recent activity
</verification>

<success_criteria>
- All admin actions logged automatically
- Activity log viewable with filters
- Audit trail persists in database
- Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel-and-auth/05-05-SUMMARY.md`
</output>
