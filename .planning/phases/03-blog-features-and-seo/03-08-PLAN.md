---
phase: 03-blog-features-and-seo
plan: "08"
type: execute
wave: 1
depends_on: ["03-07"]
files_modified:
  - app/Services/Content/MarkdownParser.php
  - resources/views/posts/show.blade.php
  - resources/js/dark-mode.js
  - resources/views/layouts/app.blade.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Code blocks render in isolated container with copy button"
    - "Headers in blog content have distinct sizes and weights (h1 > h2 > h3)"
    - "toggleTheme JavaScript function is defined and accessible"
    - "Dark mode toggle works without JavaScript errors"
  artifacts:
    - path: "app/Services/Content/MarkdownParser.php"
      provides: "Code blocks wrapped in code-block.blade.php component"
      contains: ["<x-code-block", "component('code-block')"]
    - path: "resources/views/posts/show.blade.php"
      provides: "Prose styling for headers (h1-h6) with distinct sizes"
      contains: [".prose h1", ".prose h2", ".prose h3"]
    - path: "resources/js/dark-mode.js"
      provides: "toggleTheme function accessible globally"
      contains: ["toggleTheme", "window.darkMode"]
    - path: "resources/views/layouts/app.blade.php"
      provides: "Dark-mode.js loaded before any component usage"
      contains: ["dark-mode.js"]
---

<objective>
Fix UAT gaps in blog rendering: code block container/isolation, header typography differentiation, and toggleTheme JavaScript errors.

Purpose: Close issues found during user acceptance testing.
Output: Working code block containers, distinct header styling, functional dark mode toggle.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan that created code-block component
@.planning/phases/03-blog-features-and-seo/03-04-SUMMARY.md

# Existing files that need fixes
@app/Services/Content/MarkdownParser.php
@resources/views/components/code-block.blade.php
@resources/views/posts/show.blade.php
@resources/js/dark-mode.js
@resources/views/layouts/app.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix code block container isolation</name>
  <files>app/Services/Content/MarkdownParser.php</files>
  <action>
Wrap Shiki-highlighted code blocks in the code-block.blade.php component.

Current state: MarkdownParser returns raw HTML from Shiki (with .shiki class) but doesn't wrap in the component.

Changes needed in highlightCodeBlocks():
1. Instead of returning raw HTML from $this->highlighter->highlight(), wrap it in a Blade component
2. Use Laravel's Blade compiler or component rendering
3. Pass the language and highlighted HTML to the component
4. Return the rendered component HTML

Implementation approach:
```php
// Option A: Use Blade::renderComponent (Laravel 8+)
// In MarkdownParser:
use Illuminate\Support\Facades\Blade;

protected function highlightCodeBlocks(string $html): string
{
    $pattern = '/<pre><code(?:\s+class="(?:language-|lang-)?([^"]*)")?>([^<]*)<\/code><\/pre>/s';

    return preg_replace_callback($pattern, function ($matches) use (&$blade) {
        $language = $matches[1] ?? 'code';
        $code = htmlspecialchars_decode($matches[2] ?? '', ENT_QUOTES | ENT_HTML5);
        $highlighted = $this->highlighter->highlight($code, $language);
        
        // Render the code-block component
        return Blade::renderComponent(new \Illuminate\View\ComponentSlot(
            $highlighted,
            ['language' => $language]
        ));
    }, $html);
}
```

Or simpler approach using view render:
```php
use Illuminate\Support\Facades\View;

return View::make('components.code-block', [
    'language' => $language,
    'highlighted' => $highlighted
])->render();
```

The code-block.blade.php component already exists and expects:
- `$language` prop for the language label
- `$highlighted` or `$slot` for the highlighted HTML

This gives:
- Container isolation (border, background, rounded corners)
- Copy button functionality (already in component)
- Line numbers styling
- Proper spacing and overflow handling
  </action>
  <verify>
    Check MarkdownParser:
    - Uses Blade::renderComponent or View::make to render code-block component
    - Passes language and highlighted HTML to component
    - Code blocks in output are wrapped in .relative.group.my-6 container
    
    Test by viewing a blog post with code blocks:
    - [ ] Code blocks have border and rounded corners
    - [ ] Language label appears in header
    - [ ] Copy button is visible and works
    - [ ] Line numbers display correctly
  </verify>
  <done>
    Code blocks render within the code-block.blade.php component container with copy button and proper isolation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add header typography differentiation</name>
  <files>resources/views/posts/show.blade.php</files>
  <action>
Add distinct CSS styling for h1, h2, h3 headers in blog content so they're visually differentiated.

Current state: All headers render with default prose styling, appearing same size/weight.

Changes needed in posts/show.blade.php @push('head') or @style section:
1. Add CSS overrides for .prose h1, h2, h3 with distinct:
   - Font sizes (h1 largest, h3 smallest)
   - Font weights (bold, semi-bold, medium)
   - Colors (can use Rose Pine theme colors)
   - Margins/padding for visual hierarchy
   - Borders or underlines where appropriate

Example CSS:
```css
.prose h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--rp-text);
    margin-top: 2em;
    margin-bottom: 1em;
    letter-spacing: -0.025em;
}

.prose h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--rp-text);
    margin-top: 1.5em;
    margin-bottom: 0.75em;
    border-bottom: 1px solid var(--rp-highlight-med);
    padding-bottom: 0.25em;
}

.prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--rp-subtle);
    margin-top: 1.25em;
    margin-bottom: 0.5em;
}

.prose h4 {
    font-size: 1rem;
    font-weight: 500;
    color: var(--rp-muted);
    margin-top: 1em;
    margin-bottom: 0.25em;
}
```

Key differences:
- h1: Largest, heaviest weight, no border
- h2: Medium-large, semi-bold, bottom border
- h3: Medium size, semi-bold, subtler color
- h4: Smallest, medium weight, muted color
  </action>
  <verify>
    Check posts/show.blade.php @push('head') or style section:
    - Has .prose h1, h2, h3 CSS rules
    - Each has distinct font-size, font-weight
    - h2 has border-bottom for visual separation
    
    Test by viewing blog post with multiple heading levels:
    - [ ] h1 appears largest and boldest
    - [ ] h2 has underline/border separation
    - [ ] h3 is smaller than h2
    - [ ] Visual hierarchy is clear at a glance
  </verify>
  <done>
    Headers in blog content have distinct visual hierarchy with differentiated sizes, weights, and styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix toggleTheme JavaScript undefined error</name>
  <files>resources/js/dark-mode.js, resources/views/layouts/app.blade.php</files>
  <action>
Fix "toggleTheme is not defined" JavaScript error.

Root cause likely one of:
1. Dark-mode.js not loaded in layout
2. Script loaded after toggle button tries to call it
3. window.darkMode not properly initialized
4. Event handler referencing undefined function

Current state: dark-mode.js has toggleTheme defined, but error occurs.

Changes needed:
1. Verify dark-mode.js is loaded in app.blade.php BEFORE any component usage
2. Ensure proper initialization order
3. Add defensive checks in dark-mode-toggle component

Step A: Verify app.blade.php loads dark-mode.js correctly
```blade
{{-- Load dark-mode.js early, before any component that uses it --}}
<script src="{{ asset('js/dark-mode.js') }}"></script>
{{-- Then load Alpine.js if needed --}}
```

Step B: In dark-mode-toggle.blade.php, add safety check:
```blade
<button 
    x-data="{ copied: false }"
    @click="if (typeof window.darkMode !== 'undefined') { 
        window.darkMode.toggle(); 
    } else { 
        console.error('darkMode not initialized'); 
        // Fallback: direct API call
        fetch('/api/theme/toggle', { 
            method: 'POST',
            headers: { 'X-CSRF-TOKEN': '{{ csrf_token() }}' }
        });
    }"
>
```

Step C: In dark-mode.js, ensure window.darkMode is set before any component might use it
- Move window.darkMode = darkMode to TOP of the file, not at the end
- Or ensure it's set synchronously

Step D: Add initialization verification
```js
// Immediately after darkMode object is created
if (typeof window !== 'undefined') {
    window.darkMode = darkMode;
    console.log('Dark mode initialized:', darkMode.getTheme());
}
```

This ensures:
- darkMode is available before any click handlers fire
- Graceful fallback if not loaded
- Console logging for debugging
  </action>
  <verify>
    Check resources/views/layouts/app.blade.php:
    - Loads dark-mode.js in <head> or before </body>
    - Loads before dark-mode-toggle component
    
    Check dark-mode.js:
    - window.darkMode assigned synchronously
    - No async operations before assignment
    
    Check dark-mode-toggle.blade.php:
    - Has safety check for window.darkMode existence
    - Fallback to direct API call if needed
    
    Test dark mode toggle:
    - [ ] No "toggleTheme is not defined" error in console
    - [ ] Clicking toggle successfully switches theme
    - [ ] Console shows dark mode initialized message
  </verify>
  <done>
    Dark mode toggle works without JavaScript errors. toggleTheme and window.darkMode are accessible when toggle button is clicked.
  </done>
</task>

</tasks>

<verification>
Overall gap closure verification:

1. Code blocks with container isolation:
   - [ ] View a blog post with code blocks
   - [ ] Code blocks have visible border and container
   - [ ] Copy button is visible and functional
   - [ ] Language label shows correct language

2. Header typography:
   - [ ] View blog post with h1, h2, h3 headings
   - [ ] h1 appears largest and boldest
   - [ ] h2 has visual distinction (border/underline)
   - [ ] h3 is smaller than h2
   - [ ] Clear visual hierarchy at a glance

3. Dark mode toggle:
   - [ ] Open browser console (no errors expected)
   - [ ] Click dark mode toggle
   - [ ] Theme switches without JavaScript errors
   - [ ] Console shows "Dark mode initialized" message

4. Integration:
   - [ ] All three fixes work together
   - [ ] No regressions in other functionality
</verification>

<success_criteria>
Gap closure complete when:
- Code blocks render inside code-block.blade.php component container
- Copy button works on all code blocks
- Headers (h1-h6) have distinct visual styling
- Dark mode toggle works without "toggleTheme undefined" errors
- No JavaScript console errors on blog pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-blog-features-and-seo/03-08-SUMMARY.md` documenting:
- Code block component wrapping implementation
- Header typography CSS additions
- Dark mode toggle JavaScript fixes
</output>
