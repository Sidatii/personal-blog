---
phase: 03-blog-features-and-seo
plan: 07
type: execute
wave: 4
depends_on: ["03-03", "03-04"]
files_modified:
  - app/Services/Content/MarkdownParser.php
  - app/Http/Controllers/BlogController.php
  - resources/views/posts/show.blade.php
  - resources/views/components/table-of-contents.blade.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "MarkdownParser uses ShikiHighlighter to process code blocks"
    - "Code blocks render with Rose Pine syntax highlighting via Shiki"
    - "BlogController reads markdown files and parses them"
    - "BlogController extracts headings and passes them to the view"
    - "Table of Contents displays actual post headings"
  artifacts:
    - path: "app/Services/Content/MarkdownParser.php"
      provides: "Code block highlighting via Shiki integration and headings extraction"
      contains: ["ShikiHighlighter", "highlightCodeBlocks", "getHeadings()"]
      exports: ["parse()", "getHeadings()"]
    - path: "app/Http/Controllers/BlogController.php"
      provides: "Parses markdown file, extracts content and headings"
      contains: ["MarkdownParser", "storage_path", "compact('content', 'headings')"]
    - path: "resources/views/posts/show.blade.php"
      provides: "TOC with headings data"
      contains: [":headings=\"$headings\"", "{!! $content !!}"]
  key_links:
    - from: "MarkdownParser.parse()"
      to: "ShikiHighlighter.highlight()"
      via: "method call on code blocks"
      pattern: "ShikiHighlighter.*highlight|highlightCodeBlocks"
    - from: "BlogController.show()"
      to: "MarkdownParser"
      via: "file read and parse"
      pattern: "storage_path.*content|\\$parser->parse"
    - from: "BlogController.show()"
      to: "MarkdownParser.getHeadings()"
      via: "parser extraction"
      pattern: "getHeadings\(\)"
    - from: "posts/show.blade.php"
      to: "BlogController"
      via: "content and headings variables"
      pattern: "compact.*content.*headings|\$content.*\$headings"
---

<objective>
Wire BlogController to use MarkdownParser for parsing post content, extracting headings, and passing them to the view for Table of Contents functionality.

Purpose: Close the gap where BlogController doesn't read markdown files from storage/content/posts/ - ShikiHighlighter is already integrated into MarkdownParser (verified working).

Output: Blog posts render with syntax highlighting, TOC shows actual headings, content displays correctly.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan that created ShikiHighlighter
@.planning/phases/03-blog-features-and-seo/03-03-SUMMARY.md

# Prior plan that created MarkdownParser
@.planning/phases/03-blog-features-and-seo/03-04-SUMMARY.md

# Existing files to modify
@app/Services/ShikiHighlighter.php
@app/Services/Content/MarkdownParser.php
@app/Http/Controllers/BlogController.php
@resources/views/posts/show.blade.php
@resources/views/components/code-block.blade.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify ShikiHighlighter integration (ALREADY DONE)</name>
  <files>app/Services/Content/MarkdownParser.php</files>
  <action>
Verify MarkdownParser already has ShikiHighlighter integrated.

Current state (already implemented):
- Line 13: `protected ShikiHighlighter $highlighter;`
- Line 35: `$this->highlighter = $highlighter ?? new ShikiHighlighter;`
- Lines 188-214: `highlightCodeBlocks()` method that processes code blocks
- Lines 205: `$highlighted = $this->highlighter->highlight($code, $language);`
- Lines 114-117: `getHeadings()` method exists and works

Verified via test-parser.php output:
✅ Code blocks render with .shiki class and Rose Pine colors (#191724 background)
✅ Headings extracted correctly (level, text, id)

No changes needed - integration is complete.
  </action>
  <verify>
    Check MarkdownParser:
    - Has ShikiHighlighter injected in constructor (line ~35)
    - Has highlightCodeBlocks() method that calls $this->highlighter->highlight()
    - Has getHeadings() method returning array with level/text/id
    - Code blocks in output contain .shiki class (from Shiki)
  </verify>
  <done>
    MarkdownParser uses ShikiHighlighter for code blocks and provides getHeadings() method. Integration verified working via test.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire BlogController to parse markdown files</name>
  <files>app/Http/Controllers/BlogController.php</files>
  <action>
Update BlogController show() method to read markdown file from storage and parse it with MarkdownParser.

Current state: BlogController fetches post from database but doesn't read/parse the markdown file.

Changes needed in BlogController::show():
1. Add MarkdownParser import at top of file
2. Read the markdown file from storage/content/posts/{$post->filepath}
3. Create MarkdownParser instance
4. Parse the content: `$parsed = $parser->parse($markdownContent)`
5. Extract content and headings: `$content = $parsed['body']`, `$headings = $parser->getHeadings()`
6. Pass both to view: `compact('post', 'seo', 'content', 'headings')`

The filepath format from Post model: `storage/content/posts/{filename.md}`

Handle missing files gracefully:
- If file doesn't exist, show error or fallback message
- Log warning if file missing in production

Also add reading time calculation if not already present:
- Count words in plain text content
- Average reading speed: 200 words/minute
- Round up to nearest minute
  </action>
  <verify>
    Check BlogController:
    - Imports MarkdownParser
    - Reads file using storage_path('content/posts/' . $post->filepath)
    - Creates MarkdownParser instance
    - Calls $parser->parse() or $parser->parseFile()
    - Extracts $content and $headings from parser
    - Passes both to view via compact('content', 'headings')
    - Reading time calculated and passed to view
    
    Test by viewing a post - should see:
    - Parsed HTML content with syntax highlighting
    - TOC with actual headings from the post
  </verify>
  <done>
    BlogController reads markdown files, parses them with MarkdownParser, and passes content and headings to the view.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify code blocks and TOC render correctly</name>
  <files>resources/views/posts/show.blade.php, resources/views/components/table-of-contents.blade.php</files>
  <action>
Verify code blocks and Table of Contents render correctly now that BlogController is wired.

Current state: View expects $content and $headings variables but wasn't receiving them.

Verification needed:
1. Check posts/show.blade.php line 75: Uses {!! $content !!} to render HTML
2. Check line 10-12: TOC component receives :headings="$headings"
3. Check resources/views/components/table-of-contents.blade.php:
   - Expects headings as array with 'text' and 'id' keys
   - MarkdownParser getHeadings() returns ['level', 'text', 'id']
   - Verify prop names match (might need 'slug' vs 'id')
4. Check code-block rendering:
   - Syntax highlighting should appear (Rose Pine colors)
   - .shiki class should be present on code blocks
   - Copy button should work (if implemented)

The table-of-contents component likely expects:
```php
@foreach($headings as $heading)
  <a href="#{{ $heading['id'] }}">{{ $heading['text'] }}</a>
@endforeach
```

If component expects 'slug' instead of 'id', update MarkdownParser or add accessor.
  </action>
  <verify>
    Check table-of-contents.blade.php:
    - Iterates over $headings correctly
    - Uses correct key names (text, id/slug)
    - Links generate with #anchor matching heading IDs
    
    Render a test post and verify:
    - [ ] Code blocks show syntax highlighting (Rose Pine theme)
    - [ ] TOC shows actual headings from post
    - [ ] Clicking TOC links scrolls to correct section
    - [ ] No undefined variable errors
  </verify>
  <done>
    Code blocks render with syntax highlighting, TOC displays headings, clicking TOC links works correctly.
  </done>
</task>

</tasks>

<verification>
Overall phase gap closure verification:

1. Verify BlogController integration:
   - [ ] BlogController imports MarkdownParser
   - [ ] show() method reads file from storage/content/posts/
   - [ ] Parses content and extracts headings
   - [ ] Passes $content and $headings to view

2. Verify post renders correctly:
   - [ ] Visit a blog post page (create test post first)
   - [ ] HTML content displays with proper formatting
   - [ ] Code blocks show Rose Pine syntax highlighting
   - [ ] Code blocks have .shiki class applied
   - [ ] TOC sidebar shows actual headings from the post
   - [ ] Clicking TOC links scrolls to correct section
   - [ ] No "undefined variable" errors in view

3. Create test post for verification:
   - Create storage/content/posts/hello-world.md with headings and code blocks
   - Verify it renders correctly at /blog/hello-world
</verification>

<success_criteria>
Gap closure complete when:
- BlogController reads markdown files from storage/content/posts/
- MarkdownParser parses content with ShikiHighlighter (already integrated)
- BlogController passes $content and $headings to post view
- TOC component displays actual post headings
- Code blocks render with Rose Pine syntax highlighting via Shiki
- No integration errors or missing variable warnings
</success_criteria>

<output>
After completion, create `.planning/phases/03-blog-features-and-seo/03-07-SUMMARY.md` documenting:
- ShikiHighlighter integration with MarkdownParser
- Headings extraction and TOC wiring
- Code block rendering with line numbers
- Any configuration or usage notes
</output>
