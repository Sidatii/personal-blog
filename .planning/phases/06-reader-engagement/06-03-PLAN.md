---
phase: 06-reader-engagement
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - app/Http/Controllers/Admin/CommentController.php
  - app/Http/Controllers/Admin/DashboardController.php
  - resources/views/admin/comments/index.blade.php
  - resources/views/admin/comments/_comment-card.blade.php
  - resources/views/admin/dashboard/index.blade.php
  - routes/admin.php
autonomous: true

must_haves:
  truths:
    - Admin can view all comments filtered by status (pending, approved, spam)
    - Dashboard shows pending comments count badge
    - Admin can approve pending comments
    - Admin can mark comments as spam
    - Admin can delete comments permanently
    - Comments display metadata (author, IP, post, timestamp)
  artifacts:
    - path: "app/Http/Controllers/Admin/CommentController.php"
      provides: "Admin comment moderation controller"
      exports: ["index", "approve", "spam", "destroy"]
    - path: "resources/views/admin/comments/index.blade.php"
      provides: "Comment moderation queue interface"
      contains: "Status filters, comment cards, action buttons"
    - path: "resources/views/admin/dashboard/index.blade.php"
      provides: "Updated dashboard with pending comments count"
      contains: "Pending comments stat card with link"
  key_links:
    - from: "admin dashboard"
      to: "comment moderation"
      via: "pending count badge with link"
      pattern: "route('admin.comments.index', ['status' => 'pending'])"
    - from: "comment list"
      to: "moderation actions"
      via: "POST forms for approve/spam/destroy"
      pattern: "route('admin.comments.approve', $comment)"
    - from: "Admin\CommentController"
      to: "CommentRepository"
      via: "repository method calls"
      pattern: "$this->commentRepository->approve($comment)"
---

<objective>
Build the admin moderation interface for managing comments. Includes pending queue, approval workflow, spam marking, and dashboard integration.

Purpose: Give administrators full control over comment moderation with efficient bulk actions and clear status visibility.
Output: Complete admin comment moderation system integrated with existing admin panel.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-reader-engagement/06-01-SUMMARY.md
@.planning/phases/06-reader-engagement/06-RESEARCH.md

# Existing admin patterns
@app/Http/Controllers/Admin/ProjectController.php
@app/Http/Controllers/Admin/ContactController.php
@resources/views/admin/projects/index.blade.php
@resources/views/admin/contacts/index.blade.php
@resources/views/layouts/admin.blade.php
@routes/admin.php

# Dependencies
- Plan 06-01 complete (Comment model, repository, database)
- Existing admin auth and layout (Phase 5)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Admin Comment controller with moderation actions</name>
  <files>
    app/Http/Controllers/Admin/CommentController.php
  </files>
  <action>
    Create the admin comment moderation controller following existing admin patterns:

    **Admin\CommentController** with:

    1. **Constructor injection:**
       - CommentRepositoryInterface $commentRepository
       - ActivityLogger $activityLogger (for audit trail)

    2. **index(Request $request)** method:
       - Get status filter from query (default: pending)
       - Validate status is one of: pending, approved, spam, rejected
       - Query comments with post relationship eager loaded
       - Filter by status if provided
       - Order by created_at desc (newest first)
       - Paginate 20 per page
       - Get counts for each status for filter badges
       - Return view('admin.comments.index', compact('comments', 'status', 'counts'))

    3. **approve(Comment $comment)** method:
       - Call $this->commentRepository->approve($comment)
       - Log activity: "Approved comment #{$comment->id} on '{$comment->post->title}'"
       - Flash success message
       - Redirect back to index with same status filter

    4. **spam(Comment $comment)** method:
       - Call $this->commentRepository->markAsSpam($comment)
       - Log activity: "Marked comment #{$comment->id} as spam"
       - Flash success message
       - Redirect back

    5. **destroy(Comment $comment)** method:
       - Delete comment (hard delete)
       - Log activity: "Deleted comment #{$comment->id}"
       - Flash success message
       - Redirect back

    Follow exact patterns from Admin\ContactController and Admin\ProjectController for consistency.
    All actions should validate CSRF tokens via @csrf in forms.
  </action>
  <verify>
    php artisan route:list | grep admin.comments
    grep -n "class CommentController" app/Http/Controllers/Admin/CommentController.php
  </verify>
  <done>
    Admin CommentController exists with index, approve, spam, and destroy methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin comment moderation views</name>
  <files>
    resources/views/admin/comments/index.blade.php
    resources/views/admin/comments/_comment-card.blade.php
    resources/views/components/admin-sidebar.blade.php
  </files>
  <action>
    Create moderation queue views following existing admin UI patterns:

    1. **index.blade.php** - Main moderation queue:
       - Extend 'layouts.admin' layout
       - Page header: "Comment Moderation" with total count
       - Filter tabs: Pending (count), Approved (count), Spam (count), All
         * Use active styling for current tab (Rose Pine accent color)
         * Link each tab to route with status parameter
       - Comments list:
         * If empty: show "No [status] comments" message
         * Loop: @foreach($comments as $comment) @include('admin.comments._comment-card')
       - Pagination: {{ $comments->appends(['status' => $status])->links() }}

    2. **_comment-card.blade.php** - Individual comment card:
       - Container: bg-surface rounded-lg p-4 (Rose Pine themed)
       - Header row:
         * Author name (bold) or "Anonymous" if null
         * Email (if provided, muted text)
         * Post title link ("on: [Post Title]")
         * Timestamp with diffForHumans()
       - Content: {{ $comment->content }} (escaped)
       - Metadata row (small, muted):
         * IP address: {{ $comment->ip_address }}
         * User agent snippet (truncated)
         * Status badge (colored: pending=gold, approved=foam, spam=love)
       - Action buttons (flex gap-2):
         * Approve button (if not approved) - green styling, POST form
         * Spam button (if not spam) - orange/red styling, POST form
         * Delete button - red styling, POST with DELETE method, confirm dialog
       - If comment is highlighted: show star badge

    3. **Update admin sidebar** (resources/views/components/admin-sidebar.blade.php):
       - Add "Comments" navigation item with icon (chat/comment icon)
       - Show badge with pending count if > 0
       - Link to admin.comments.index with status=pending
       - Place after "Contacts" in sidebar order

    Follow existing Rose Pine admin theme colors:
    - Surface: bg-surface, text-text
    - Accents: text-love (urgent), text-foam (success), text-gold (warning)
    - Buttons: Follow existing btn classes in admin views
  </action>
  <verify>
    grep -n "admin.comments.index" resources/views/components/admin-sidebar.blade.php
    ls -la resources/views/admin/comments/
    grep -n "Comment Moderation" resources/views/admin/comments/index.blade.php
  </verify>
  <done>
    Index view created, comment card partial created, sidebar updated with comments link and pending badge
  </done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard with comment stats and add admin routes</name>
  <files>
    app/Http/Controllers/Admin/DashboardController.php
    resources/views/admin/dashboard/index.blade.php
    routes/admin.php
  </files>
  <action>
    Integrate comments into admin dashboard and register routes:

    1. **Update DashboardController** (app/Http/Controllers/Admin/DashboardController.php):
       - Inject CommentRepositoryInterface in constructor
       - In index() method, add to stats array:
         * 'pending_comments' => $this->commentRepository->getPendingCount()
         * 'total_comments' => Comment::count()
       - Add to recent activity:
         * 'recent_comments' => Comment::with('post')->latest()->limit(5)->get()

    2. **Update dashboard view** (resources/views/admin/dashboard/index.blade.php):
       - Add stat card for "Pending Comments":
         * Icon: chat/comment icon
         * Number: {{ $stats['pending_comments'] }}
         * Link to admin.comments.index?status=pending
         * Show badge highlighting if > 0
       - Add "Recent Comments" section:
         * Card below existing recent activity
         * List last 5 comments with author, post title, snippet, time
         * Link to moderation queue

    3. **Add admin routes** (routes/admin.php):
       - Route::get('/comments', [CommentController::class, 'index'])->name('admin.comments.index')
       - Route::post('/comments/{comment}/approve', [CommentController::class, 'approve'])->name('admin.comments.approve')
       - Route::post('/comments/{comment}/spam', [CommentController::class, 'spam'])->name('admin.comments.spam')
       - Route::delete('/comments/{comment}', [CommentController::class, 'destroy'])->name('admin.comments.destroy')
       - Group with admin auth middleware (already applied to file)

    4. **Add sidebar navigation** (already done in Task 2, verify links work):
       - Comments link with pending count badge
       - Active state highlighting

    Ensure all routes are named and use proper HTTP verbs.
  </action>
  <verify>
    php artisan route:list | grep admin.comments
    grep -n "pending_comments" resources/views/admin/dashboard/index.blade.php
    grep -n "Recent Comments" resources/views/admin/dashboard/index.blade.php
  </verify>
  <done>
    Dashboard shows pending comment count, recent comments section visible, all admin routes registered and accessible
  </done>
</task>

</tasks>

<verification>
1. Test routes: php artisan route:list | grep admin.comments
2. Verify controller: grep -n "class CommentController" app/Http/Controllers/Admin/CommentController.php
3. Check views exist: ls -la resources/views/admin/comments/
4. Verify dashboard integration: grep -n "comments" resources/views/admin/dashboard/index.blade.php
5. Test sidebar: grep -n "comments" resources/views/components/admin-sidebar.blade.php
</verification>

<success_criteria>
- Admin CommentController with index, approve, spam, destroy methods
- Comment moderation queue view with status filters
- Individual comment cards with metadata and action buttons
- Dashboard shows pending comments count with link
- Recent comments section on dashboard
- Sidebar navigation with comments link and pending badge
- All admin routes registered and protected by admin auth
</success_criteria>

<output>
After completion, create `.planning/phases/06-reader-engagement/06-03-SUMMARY.md`
</output>
