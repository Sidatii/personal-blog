---
phase: 06-reader-engagement
plan: 04
type: execute
wave: 3
depends_on: []
files_modified:
  - docker-compose.umami.yml
  - config/services.php
  - resources/views/components/umami-tracking.blade.php
  - resources/views/layouts/base.blade.php
  - .env.example
autonomous: true
user_setup:
  - service: umami
    why: "Self-hosted privacy-first analytics"
    env_vars:
      - name: UMAMI_HOST
        description: "URL where Umami is hosted (e.g., https://stats.yourdomain.com)"
      - name: UMAMI_WEBSITE_ID
        description: "Website ID from Umami dashboard (UUID)"
    dashboard_config:
      - task: "Start Umami containers"
        command: "docker-compose -f docker-compose.umami.yml up -d"
      - task: "Access Umami dashboard"
        location: "http://localhost:3000 (or configured UMAMI_HOST)"
        credentials: "admin / umami"
      - task: "Add website in Umami"
        steps:
          - "Click 'Add website'"
          - "Enter site name and domain"
          - "Copy the generated Website ID"
      - task: "Add Website ID to .env"
        location: ".env file"
        var: "UMAMI_WEBSITE_ID=your-copied-id"

must_haves:
  truths:
    - Umami analytics script loads on all pages (production only)
    - Script respects Do Not Track browser setting
    - Tracking is disabled in non-production environments
    - Analytics dashboard is accessible for viewing metrics
    - Page views, unique visitors, referrers, devices are tracked
  artifacts:
    - path: "docker-compose.umami.yml"
      provides: "Umami self-hosting configuration"
      contains: "Umami service, PostgreSQL database, volumes, healthcheck"
    - path: "resources/views/components/umami-tracking.blade.php"
      provides: "Analytics tracking script component"
      contains: "Script tag with data-website-id, conditional on production"
    - path: "config/services.php"
      provides: "Umami configuration"
      contains: "umami.host, umami.website_id"
  key_links:
    - from: "base layout"
      to: "umami-tracking component"
      via: "@include in <head>"
      pattern: "<x-umami-tracking /> in base.blade.php"
    - from: "umami-tracking component"
      to: "Umami server"
      via: "script src with data-website-id"
      pattern: "config('services.umami.host')/script.js"
---

<objective>
Integrate privacy-first Umami analytics with self-hosted deployment option. Includes Docker Compose configuration, Laravel tracking integration, and environment configuration.

Purpose: Track reader engagement metrics while maintaining privacy and data ownership.
Output: Working Umami deployment with page tracking on all blog pages.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-reader-engagement/06-CONTEXT.md
@.planning/phases/06-reader-engagement/06-RESEARCH.md

# Existing layouts
@resources/views/layouts/base.blade.php
@config/services.php
@.env.example

# Notes
- Docker Compose is the recommended deployment method
- Script tag integration (not package) for simplicity
- Production-only tracking (disable in local dev)
- No user_setup required for automation - only for manual dashboard config
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Umami Docker Compose configuration</name>
  <files>
    docker-compose.umami.yml
  </files>
  <action>
    Create production-ready Docker Compose configuration for Umami analytics:

    **docker-compose.umami.yml** with:

    1. **Umami service:**
       - Image: ghcr.io/umami-software/umami:postgresql-latest
       - Ports: 3000:3000
       - Environment:
         * DATABASE_URL: postgresql://umami:${UMAMI_DB_PASSWORD:-umami}@umami-db:5432/umami
         * DATABASE_TYPE: postgresql
         * HASH_SALT: ${UMAMI_HASH_SALT} (generate with: openssl rand -hex 32)
         * TRACKER_SCRIPT_NAME: ${UMAMI_TRACKER_SCRIPT:-script.js} (optional obfuscation)
       - Depends_on: umami-db
       - Restart: always
       - Healthcheck:
         * Test: curl -f http://localhost:3000/api/health || exit 1
         * Interval: 30s, timeout: 10s, retries: 3

    2. **PostgreSQL service (umami-db):**
       - Image: postgres:16-alpine
       - Environment:
         * POSTGRES_DB: umami
         * POSTGRES_USER: umami
         * POSTGRES_PASSWORD: ${UMAMI_DB_PASSWORD:-umami}
       - Volumes: umami-db-data:/var/lib/postgresql/data
       - Restart: always

    3. **Volumes:**
       - umami-db-data: (named volume for persistence)

    4. **Networks:**
       - Default bridge network (isolated from main app)

    Include comments explaining:
    - How to generate HASH_SALT
    - Default credentials (admin/umami - change immediately)
    - Where to access dashboard
    - How to view logs: docker-compose -f docker-compose.umami.yml logs -f

    This keeps Umami completely isolated from the main Laravel application database.
  </action>
  <verify>
    cat docker-compose.umami.yml | grep "umami-software/umami"
    cat docker-compose.umami.yml | grep "umami-db-data"
    docker-compose -f docker-compose.umami.yml config (validate syntax)
  </verify>
  <done>
    Docker Compose file exists with valid syntax, includes both Umami and PostgreSQL services
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Umami tracking component and Laravel configuration</name>
  <files>
    config/services.php
    resources/views/components/umami-tracking.blade.php
    .env.example
  </files>
  <action>
    Create Laravel integration for Umami tracking:

    1. **Update config/services.php** - Add Umami section:
       Add to returned array:
       ```php
       'umami' => [
           'host' => env('UMAMI_HOST'),
           'website_id' => env('UMAMI_WEBSITE_ID'),
           'enabled' => env('UMAMI_ENABLED', true),
       ],
       ```

    2. **Create umami-tracking component** (resources/views/components/umami-tracking.blade.php):
       ```blade
       @if(config('services.umami.enabled') && config('services.umami.host') && config('services.umami.website_id') && app()->environment('production'))
           <script async defer
               src="{{ config('services.umami.host') }}/{{ config('services.umami.script_name', 'script.js') }}"
               data-website-id="{{ config('services.umami.website_id') }}"
               data-do-not-track="true"
               data-cache="true">
           </script>
       @endif
       ```
       
       Features:
       - Only loads in production environment
       - Respects Do Not Track browser setting (data-do-not-track)
       - Caches the script (data-cache)
       - Checks all required config is present

    3. **Update .env.example** - Add Umami variables:
       ```
       # Umami Analytics (Privacy-First)
       UMAMI_HOST=https://stats.yourdomain.com
       UMAMI_WEBSITE_ID=
       UMAMI_ENABLED=true
       ```

    4. **Document environment variables** in comments:
       - UMAMI_HOST: Full URL to Umami instance (no trailing slash)
       - UMAMI_WEBSITE_ID: UUID from Umami dashboard
       - UMAMI_ENABLED: Set to false to disable tracking globally

    The component uses Laravel's config system for flexibility while maintaining security.
  </action>
  <verify>
    grep -n "umami" config/services.php
    grep -n "UMAMI" .env.example
    ls -la resources/views/components/umami-tracking.blade.php
  </verify>
  <done>
    Config updated with Umami section, component created, .env.example updated
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate tracking into base layout</name>
  <files>
    resources/views/layouts/base.blade.php
    resources/views/admin/dashboard/index.blade.php
  </files>
  <action>
    Add Umami tracking to the main layout and admin dashboard:

    1. **Integrate into base layout** (resources/views/layouts/base.blade.php):
       - Find the closing </head> tag
       - Just before </head>, add: @include('components.umami-tracking')
       - Or use: <x-umami-tracking />
       
       Alternative placement if using Laravel 8+ components:
       - If layout uses <x-component-name /> pattern, use: <x-umami-tracking />

    2. **Update admin dashboard** (resources/views/admin/dashboard/index.blade.php):
       - Add "Analytics" section or card:
       - Link to Umami dashboard with external link icon
       - Display current UMAMI_HOST if configured
       - Show status: "Active" (green) if configured, "Not configured" (gray) if not
       
       Example card content:
       ```
       Analytics
       Track visitor engagement with privacy-first analytics
       
       Status: Active (or: Not configured)
       Dashboard: https://stats.yourdomain.com
       
       [Open Dashboard] (external link)
       ```

    3. **Verify integration**:
       - Check that component is in <head> section
       - Ensure it doesn't break existing layout
       - Confirm it only renders in production

    4. **Optional: Add tracking to specific events** (if time permits):
       - Track outbound link clicks
       - Track reaction button usage
       - Add to Alpine.js reaction component: umami.track('Reaction', {type: 'heart'})
       
       This requires adding Umami event tracking script after main script.

    The tracking script loads asynchronously and won't block page rendering.
  </action>
  <verify>
    grep -n "umami-tracking" resources/views/layouts/base.blade.php
    grep -n "Analytics" resources/views/admin/dashboard/index.blade.php
    grep -n "UMAMI_HOST" resources/views/admin/dashboard/index.blade.php
  </verify>
  <done>
    Tracking script included in base layout head, admin dashboard shows analytics status/link
  </done>
</task>

</tasks>

<verification>
1. Validate Docker Compose: docker-compose -f docker-compose.umami.yml config
2. Verify component: cat resources/views/components/umami-tracking.blade.php
3. Check layout integration: grep -n "umami" resources/views/layouts/base.blade.php
4. Verify config: grep -A5 "umami" config/services.php
5. Check .env.example: grep "UMAMI" .env.example
</verification>

<success_criteria>
- docker-compose.umami.yml with Umami + PostgreSQL services
- Umami configuration in config/services.php
- umami-tracking Blade component with production-only logic
- Tracking script included in base layout
- Admin dashboard shows analytics status
- Environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/06-reader-engagement/06-04-SUMMARY.md`
</output>
