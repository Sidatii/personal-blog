---
phase: 01-core-publishing
plan: "03"
type: execute
wave: 3
depends_on: ["01-02"]
files_modified: []
autonomous: true
must_haves:
  truths:
    - "Content indexer reads markdown files and creates Post records"
    - "Manual `php artisan content:sync` command works end-to-end"
    - "Changes to markdown files are detected and updated in database"
  artifacts:
    - path: "app/Services/Content/ContentIndexer.php"
      provides: "Service that indexes content from markdown files"
    - path: "app/Console/Commands/SyncContentCommand.php"
      provides: "Artisan command to sync content"
    - path: "content/posts/"
      provides: "Directory for markdown content files"
  key_links:
    - from: "app/Console/Commands/SyncContentCommand.php"
      to: "app/Services/Content/ContentIndexer.php"
      via: "Method call"
      pattern: "\\$this->call\\(ContentIndexer::class"
    - from: "app/Services/Content/ContentIndexer.php"
      to: "app/Repositories/Eloquent/PostRepository.php"
      via: "Dependency injection"
      pattern: "inject.*PostRepository"
    - from: "app/Services/Content/ContentIndexer.php"
      to: "app/Services/Content/MarkdownParser.php"
      via: "Dependency injection"
      pattern: "inject.*MarkdownParser"
---

<objective>
Create the content indexer service and Artisan command that ties everything together. This completes Phase 1 by providing end-to-end content syncing from markdown files to database records.

Purpose: Enable the workflow where writing a markdown file to `content/posts/` and running `php artisan content:sync` creates a Post record with proper metadata and relationships.

Output: Working `php artisan content:sync` command that indexes all markdown content files into the database.
</objective>

<execution_context>
@/home/human/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/human/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/SUMMARY.md
@.planning/phases/01-core-publishing/01-01-PLAN.md
@.planning/phases/01-core-publishing/01-02-PLAN.md

# Content Indexing Workflow

1. Scan `content/posts/` directory for .md files
2. Read each file and parse with MarkdownParser
3. Extract frontmatter (title, category, tags, etc.)
4. Calculate MD5 hash of file content
5. Upsert Post record via PostRepository::updateOrCreateFromIndex()
6. Sync tags to post via TagRepository::syncToPost()
7. Resolve category via CategoryRepository::findOrCreate()
8. Return count of indexed posts

# Change Detection Logic
- Compare `content_hash` from database with calculated MD5
- If different: update the Post record
- If same: skip (no changes)
- Use `--force` flag to bypass change detection and reindex all
</context>

<tasks>

<task type="auto">
  <name>Task 6: Create content indexer service</name>
  <files>app/Services/Content/ContentIndexer.php</files>
  <action>
    Create ContentIndexer service (`app/Services/Content/ContentIndexer.php`):

    **Constructor with dependency injection**:
    ```php
    public function __construct(
        PostRepositoryInterface $posts,
        CategoryRepositoryInterface $categories,
        TagRepository $tags,
        MarkdownParser $parser
    ) {
        $this->posts = $posts;
        $this->categories = $categories;
        $this->tags = $tags;
        $this->parser = $parser;
    }
    ```

    **indexFile(string $filepath): Post** — Index single file:
    - Read file content: `file_get_contents($filepath)`
    - Calculate hash: `md5($content)`
    - Parse markdown: `$result = $this->parser->parse($content)`
    - Extract matter: `$matter = $result['matter']`
    - Resolve category: `$category = $this->categories->findOrCreate($matter['category'] ?? 'Uncategorized', Str::slug($matter['category'] ?? 'uncategorized'));`
    - Resolve tags: Extract from `$matter['tags']`, findOrCreate each, collect IDs
    - Upsert post: `$post = $this->posts->updateOrCreateFromIndex([...])`
    - Sync tags: `$this->tags->syncToPost($post, $tagIds);`
    - Return `$post`

    **indexAll(): int** — Index all files in content/posts/:
    - Get all .md files: `$files = glob(resource_path('content/posts/*.md'));`
    - Loop and call `indexFile()` for each
    - Return count of indexed posts
    - Log progress: `$this->info("Indexed: {$filepath}");`

    **detectChanges(): Collection** — Find changed files:
    - Get all files in content/posts/
    - Calculate MD5 for each
    - Compare with `content_hash` in database
    - Return collection of changed file paths

    **rebuild(): int** — Clear and reindex all:
    - Delete all Post records: `$this->posts->truncate();` (or use query builder)
    - Call `indexAll()`
    - Return count
  </action>
  <verify>
    Test content indexer:
    ```bash
    # Create test markdown file
    mkdir -p content/posts
    echo -e "---\ntitle: First Post\ncategory: Tech\n---\n\nHello **world**" > content/posts/first.md

    # Run indexer
    php artisan tinker
    $indexer = app(ContentIndexer::class);
    $count = $indexer->indexAll();
    echo "Indexed: {$count} posts";

    # Verify post was created
    $post = \App\Models\Post::first();
    echo $post->title;  // Should output: First Post
    echo $post->category->name;  // Should output: Tech
    ```
  </verify>
  <done>
    Content indexer reads markdown files, creates Post records with correct metadata, and syncs relationships
  </done>
</task>

<task type="auto">
  <name>Task 7: Create content sync Artisan command</name>
  <files>app/Console/Commands/SyncContentCommand.php</files>
  <action>
    Create Artisan command `php artisan content:sync` (`app/Console/Commands/SyncContentCommand.php`):

    **Command signature**:
    ```php
    protected $signature = 'content:sync {--force : Force re-index all files}';
    ```

    **Handle method**:
    ```php
    public function handle(ContentIndexer $indexer)
    {
        $this->info('Scanning content/posts/ directory...');

        if ($this->option('force')) {
            $this->info('Force re-indexing all content...');
            $count = $indexer->rebuild();
        } else {
            $changed = $indexer->detectChanges();
            if ($changed->isEmpty()) {
                $this->info('No changes detected.');
                return Command::SUCCESS;
            }
            $this->info("Found {$changed->count()} changed files...");
            $count = 0;
            foreach ($changed as $file) {
                $indexer->indexFile($file);
                $count++;
                $this->line("Indexed: {$file}");
            }
        }

        $this->info("Content sync complete. {$count} posts indexed.");
        return Command::SUCCESS;
    }
    ```

    **Register command** in `app/Console/Kernel.php`:
    ```php
    protected $commands = [
        Commands\SyncContentCommand::class,
    ];
    ```

    **Create content directory**:
    ```bash
    mkdir -p content/posts
    echo "# Welcome\n\nStart writing..." > content/posts/welcome.md
    ```
  </action>
  <verify>
    Test the complete content sync workflow:
    ```bash
    # 1. Verify command exists
    php artisan content:sync --help

    # 2. Run initial sync
    php artisan content:sync
    # Expected output:
    # Scanning content/posts/ directory...
    # Content sync complete. 1 posts indexed.

    # 3. Verify post was created
    php artisan tinker --execute="echo \App\Models\Post::first()->title;"

    # 4. Test --force flag
    php artisan content:sync --force
    ```
  </verify>
  <done>
    `php artisan content:sync` command exists, indexes markdown files, and creates Post records with relationships
  </done>
</task>

</tasks>

<verification>
## Phase 1 Complete Verification

Run this end-to-end test:

```bash
# 1. Fresh migration
php artisan migrate:fresh --path=database/migrations/

# 2. Create test content
mkdir -p content/posts
cat > content/posts/test-post.md << 'EOF'
---
title: My First Blog Post
category: Technology
tags: laravel, php, web-dev
excerpt: This is a test post for verification
published_at: 2026-02-06
is_featured: true
---

# Introduction

This is my **first** blog post written in *markdown*.

## Code Example

```php
echo "Hello World";
```

## Conclusion

Thanks for reading!
EOF

# 3. Run content sync
php artisan content:sync

# 4. Verify in database
php artisan tinker
$post = \App\Models\Post::first();
echo $post->title;  // "My First Blog Post"
echo $post->category->name;  // "Technology"
echo $post->tags->pluck('name')->implode(', ');  // "laravel, php, web-dev"
echo $post->is_featured ? 'Featured' : 'Not featured';  // "Featured"
```
</verification>

<success_criteria>
## Phase 1 Complete Success Criteria

**Functional:**
- [ ] `php artisan content:sync` indexes all markdown files in `content/posts/`
- [ ] Posts created with correct metadata (title, slug, excerpt, published_at, is_featured)
- [ ] Categories created/linked correctly
- [ ] Tags created/linked correctly via pivot table
- [ ] `--force` flag reindexes all content
- [ ] Change detection works (modifying file triggers update)

**Quality:**
- [ ] Content directory (`content/posts/`) exists and is git-synced
- [ ] Command provides meaningful output
- [ ] No errors on empty content directory
- [ ] MD5 hash comparison prevents unnecessary updates
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-publishing/01-03-SUMMARY.md`
</output>
